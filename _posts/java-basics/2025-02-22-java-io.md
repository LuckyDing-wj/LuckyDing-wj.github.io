---
layout: post
title: "Java IO 流详解"
date: 2025-02-22 23:45:00 +0800
categories: [Java基础]
tags: [Java, IO, NIO, 文件操作]
---

## 一、IO 流体系结构

```
InputStream（字节输入流）
├── FileInputStream
├── BufferedInputStream
├── DataInputStream
├── ObjectInputStream
└── ByteArrayInputStream

OutputStream（字节输出流）
├── FileOutputStream
├── BufferedOutputStream
├── DataOutputStream
├── ObjectOutputStream
└── ByteArrayOutputStream

Reader（字符输入流）
├── FileReader
├── BufferedReader
├── InputStreamReader
└── StringReader

Writer（字符输出流）
├── FileWriter
├── BufferedWriter
├── OutputStreamWriter
├── PrintWriter
└── StringWriter
```

---

## 二、字节流

### FileInputStream / FileOutputStream

```java
import java.io.*;

public class ByteStreamDemo {
    public static void main(String[] args) {
        // 写入文件
        try (FileOutputStream fos = new FileOutputStream("test.txt")) {
            String content = "Hello, World!";
            fos.write(content.getBytes());
        } catch (IOException e) {
            e.printStackTrace();
        }

        // 读取文件
        try (FileInputStream fis = new FileInputStream("test.txt")) {
            int data;
            while ((data = fis.read()) != -1) {
                System.out.print((char) data);
            }
        } catch (IOException e) {
            e.printStackTrace();
        }

        // 读取到字节数组
        try (FileInputStream fis = new FileInputStream("test.txt")) {
            byte[] buffer = new byte[1024];
            int length;
            while ((length = fis.read(buffer)) != -1) {
                System.out.print(new String(buffer, 0, length));
            }
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}
```

### BufferedInputStream / BufferedOutputStream

```java
// 缓冲流提高读写性能
public class BufferDemo {
    public static void main(String[] args) {
        // 复制文件
        try (BufferedInputStream bis = new BufferedInputStream(new FileInputStream("input.txt"));
             BufferedOutputStream bos = new BufferedOutputStream(new FileOutputStream("output.txt"))) {

            byte[] buffer = new byte[8192];
            int length;
            while ((length = bis.read(buffer)) != -1) {
                bos.write(buffer, 0, length);
            }
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}
```

---

## 三、字符流

### FileReader / FileWriter

```java
public class CharStreamDemo {
    public static void main(String[] args) {
        // 写入文件
        try (FileWriter writer = new FileWriter("text.txt")) {
            writer.write("你好，Java！\n");
            writer.write("这是字符流示例。");
        } catch (IOException e) {
            e.printStackTrace();
        }

        // 读取文件
        try (FileReader reader = new FileReader("text.txt")) {
            int data;
            while ((data = reader.read()) != -1) {
                System.out.print((char) data);
            }
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}
```

### BufferedReader / BufferedWriter

```java
public class BufferCharDemo {
    public static void main(String[] args) {
        // 逐行读取
        try (BufferedReader br = new BufferedReader(new FileReader("text.txt"))) {
            String line;
            while ((line = br.readLine()) != null) {
                System.out.println(line);
            }
        } catch (IOException e) {
            e.printStackTrace();
        }

        // 写入行
        try (BufferedWriter bw = new BufferedWriter(new FileWriter("text.txt", true))) {
            bw.write("新的一行");
            bw.newLine();  // 换行
            bw.write("另一行");
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}
```

### PrintWriter（便捷写入）

```java
public class PrintWriterDemo {
    public static void main(String[] args) {
        try (PrintWriter pw = new PrintWriter(new FileWriter("output.txt"))) {
            pw.println("Hello");
            pw.println(123);
            pw.printf("格式化输出：%s-%d", "测试", 456);
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}
```

---

## 四、转换流

```java
import java.io.*;
import java.nio.charset.*;

public class ConversionStream {
    public static void main(String[] args) {
        // 指定编码读取
        try (InputStreamReader isr = new InputStreamReader(
                new FileInputStream("test.txt"), StandardCharsets.UTF_8);
             BufferedReader br = new BufferedReader(isr)) {

            String line;
            while ((line = br.readLine()) != null) {
                System.out.println(line);
            }
        } catch (IOException e) {
            e.printStackTrace();
        }

        // 指定编码写入
        try (OutputStreamWriter osw = new OutputStreamWriter(
                new FileOutputStream("test.txt"), StandardCharsets.UTF_8);
             BufferedWriter bw = new BufferedWriter(osw)) {

            bw.write("UTF-8 编码内容");
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}
```

---

## 五、对象序列化

### Serializable 接口

```java
import java.io.*;

// 可序列化的类
public class Person implements Serializable {
    private static final long serialVersionUID = 1L;

    private String name;
    private int age;
    // transient 修饰的字段不会被序列化
    private transient String password;

    public Person(String name, int age, String password) {
        this.name = name;
        this.age = age;
        this.password = password;
    }

    @Override
    public String toString() {
        return "Person{name='" + name + "', age=" + age + ", password='" + password + "'}";
    }
}
```

### 序列化与反序列化

```java
public class SerializationDemo {
    public static void main(String[] args) {
        Person person = new Person("张三", 25, "123456");

        // 序列化（保存对象到文件）
        try (ObjectOutputStream oos = new ObjectOutputStream(
                new FileOutputStream("person.dat"))) {
            oos.writeObject(person);
            System.out.println("序列化成功");
        } catch (IOException e) {
            e.printStackTrace();
        }

        // 反序列化（从文件读取对象）
        try (ObjectInputStream ois = new ObjectInputStream(
                new FileInputStream("person.dat"))) {
            Person loaded = (Person) ois.readObject();
            System.out.println("反序列化成功: " + loaded);
            // password 字段为 null（transient）
        } catch (IOException | ClassNotFoundException e) {
            e.printStackTrace();
        }
    }
}
```

---

## 六、File 类

```java
import java.io.*;
import java.nio.file.*;

public class FileDemo {
    public static void main(String[] args) {
        File file = new File("test.txt");

        // 文件信息
        System.out.println("是否存在: " + file.exists());
        System.out.println("是否是文件: " + file.isFile());
        System.out.println("是否是目录: " + file.isDirectory());
        System.out.println("文件名: " + file.getName());
        System.out.println("绝对路径: " + file.getAbsolutePath());
        System.out.println("文件大小: " + file.length() + " 字节");

        // 文件操作
        try {
            // 创建新文件
            boolean created = file.createNewFile();

            // 创建目录
            File dir = new File("mydir/subdir");
            dir.mkdirs();  // 创建多级目录

            // 删除文件
            boolean deleted = file.delete();

            // 重命名
            file.renameTo(new File("newname.txt"));

        } catch (IOException e) {
            e.printStackTrace();
        }

        // 遍历目录
        File dir = new File(".");
        File[] files = dir.listFiles();
        if (files != null) {
            for (File f : files) {
                System.out.println(f.getName() + (f.isDirectory() ? " [目录]" : " [文件]"));
            }
        }
    }
}
```

---

## 七、NIO（New IO）

### Path 和 Paths

```java
import java.nio.file.*;
import java.nio.charset.*;

public class NIODemo {
    public static void main(String[] args) throws IOException {
        // 创建 Path
        Path path = Paths.get("test.txt");

        // 快速读写
        // 读取所有内容
        String content = Files.readString(path, StandardCharsets.UTF_8);
        System.out.println(content);

        // 读取所有行
        List<String> lines = Files.readAllLines(path, StandardCharsets.UTF_8);
        lines.forEach(System.out::println);

        // 写入内容
        Files.writeString(path, "Hello NIO!", StandardCharsets.UTF_8);

        // 复制文件
        Files.copy(Paths.get("source.txt"), Paths.get("dest.txt"),
                   StandardCopyOption.REPLACE_EXISTING);

        // 移动文件
        Files.move(Paths.get("old.txt"), Paths.get("new.txt"),
                   StandardCopyOption.REPLACE_EXISTING);

        // 删除文件
        Files.deleteIfExists(path);
    }
}
```

### Files 操作目录

```java
public class NIOFileTree {
    public static void main(String[] args) throws IOException {
        Path start = Paths.get(".");

        // 遍历目录树
        Files.walkFileTree(start, new SimpleFileVisitor<Path>() {
            @Override
            public FileVisitResult visitFile(Path file, BasicFileAttributes attrs) {
                System.out.println("文件: " + file);
                return FileVisitResult.CONTINUE;
            }

            @Override
            public FileVisitResult preVisitDirectory(Path dir, BasicFileAttributes attrs) {
                System.out.println("进入目录: " + dir);
                return FileVisitResult.CONTINUE;
            }
        });

        // 查找文件
        try (Stream<Path> paths = Files.find(Paths.get("."), 10,
                (path, attrs) -> path.toString().endsWith(".java"))) {
            paths.forEach(System.out::println);
        }

        // 读取目录内容
        try (Stream<Path> stream = Files.list(Paths.get("."))) {
            stream.forEach(System.out::println);
        }
    }
}
```

### Channel 和 Buffer

```java
import java.io.*;
import java.nio.*;
import java.nio.channels.*;

public class ChannelDemo {
    public static void main(String[] args) throws IOException {
        // 文件复制（使用 Channel）
        try (FileChannel srcChannel = new FileInputStream("input.txt").getChannel();
             FileChannel destChannel = new FileOutputStream("output.txt").getChannel()) {

            // 方式1：使用 Buffer
            ByteBuffer buffer = ByteBuffer.allocate(1024);
            while (srcChannel.read(buffer) != -1) {
                buffer.flip();  // 切换到读模式
                destChannel.write(buffer);
                buffer.clear(); // 清空 buffer
            }

            // 方式2：直接传输（效率高）
            // destChannel.transferFrom(srcChannel, 0, srcChannel.size());
        }
    }
}
```

---

## 八、常见用例

### 复制文件（多种方式）

```java
public class FileCopy {

    // 方式1：字节流
    public static void copyWithStream(String src, String dest) throws IOException {
        try (FileInputStream fis = new FileInputStream(src);
             FileOutputStream fos = new FileOutputStream(dest)) {
            byte[] buffer = new byte[8192];
            int length;
            while ((length = fis.read(buffer)) != -1) {
                fos.write(buffer, 0, length);
            }
        }
    }

    // 方式2：缓冲流
    public static void copyWithBuffer(String src, String dest) throws IOException {
        try (BufferedInputStream bis = new BufferedInputStream(new FileInputStream(src));
             BufferedOutputStream bos = new BufferedOutputStream(new FileOutputStream(dest))) {
            byte[] buffer = new byte[8192];
            int length;
            while ((length = bis.read(buffer)) != -1) {
                bos.write(buffer, 0, length);
            }
        }
    }

    // 方式3：NIO
    public static void copyWithNIO(String src, String dest) throws IOException {
        Files.copy(Paths.get(src), Paths.get(dest), StandardCopyOption.REPLACE_EXISTING);
    }
}
```

### 读取配置文件

```java
import java.io.*;
import java.util.*;

public class ConfigReader {
    public static void main(String[] args) {
        Properties props = new Properties();

        try (InputStream is = new FileInputStream("config.properties")) {
            props.load(is);

            String dbUrl = props.getProperty("db.url");
            String dbUser = props.getProperty("db.user");
            String dbPassword = props.getProperty("db.password");

            System.out.println("数据库配置:");
            System.out.println("URL: " + dbUrl);
            System.out.println("User: " + dbUser);

        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}
```

---

## 九、字节流 vs 字符流选择

| 场景 | 推荐流 |
|------|--------|
| 文本文件 | Reader/Writer |
| 二进制文件（图片、视频等） | InputStream/OutputStream |
| 需要指定编码 | InputStreamReader/OutputStreamWriter |
| 性能要求高 | Buffered + NIO |
| 对象序列化 | ObjectInputStream/ObjectOutputStream |

---

## 十、try-with-resources 深入

### 自定义 AutoCloseable

```java
public class MyResource implements AutoCloseable {
    private String name;

    public MyResource(String name) {
        this.name = name;
        System.out.println(name + " 已打开");
    }

    public void doWork() {
        System.out.println(name + " 正在工作");
    }

    @Override
    public void close() {
        System.out.println(name + " 已关闭");
    }
}

// 使用
try (MyResource r1 = new MyResource("资源A");
     MyResource r2 = new MyResource("资源B")) {
    r1.doWork();
    r2.doWork();
}
// 关闭顺序与声明顺序相反：资源B 先关闭，资源A 后关闭
```

### Suppressed Exceptions

```java
// 当 try 块和 close() 都抛异常时
// close() 的异常会作为 suppressed exception 附加
try (MyResource r = new MyResource("资源")) {
    throw new RuntimeException("业务异常");
} catch (Exception e) {
    System.out.println("主异常: " + e.getMessage());
    for (Throwable suppressed : e.getSuppressed()) {
        System.out.println("抑制异常: " + suppressed.getMessage());
    }
}
```

---

## 十一、常用 IO 模式

### 逐行处理大文件（内存友好）

```java
// 使用 BufferedReader
try (BufferedReader br = Files.newBufferedReader(Paths.get("large.txt"))) {
    String line;
    while ((line = br.readLine()) != null) {
        processLine(line);
    }
}

// 使用 Stream（更简洁）
try (Stream<String> lines = Files.lines(Paths.get("large.txt"))) {
    lines.filter(line -> line.contains("ERROR"))
         .map(String::trim)
         .forEach(System.out::println);
}
```

### 临时文件

```java
// 创建临时文件
Path tempFile = Files.createTempFile("prefix_", ".tmp");
System.out.println("临时文件: " + tempFile);

// 写入内容
Files.writeString(tempFile, "临时数据");

// 程序退出时自动删除
tempFile.toFile().deleteOnExit();
```

### 文件属性

```java
Path path = Paths.get("test.txt");

// 基本属性
BasicFileAttributes attrs = Files.readAttributes(path, BasicFileAttributes.class);
System.out.println("大小: " + attrs.size());
System.out.println("创建时间: " + attrs.creationTime());
System.out.println("修改时间: " + attrs.lastModifiedTime());
System.out.println("是否目录: " + attrs.isDirectory());

// 判断权限
System.out.println("可读: " + Files.isReadable(path));
System.out.println("可写: " + Files.isWritable(path));
```

---

## 练习题

1. 实现一个简易的文本编辑器（读写文件）
2. 统计一个文本文件中各单词的出现频率
3. 实现文件拆分和合并功能
4. 使用 NIO 实现一个文件监控程序

---

## 相关链接

- [学习资源汇总](/2025/02/22/learning-resources.html)
- [返回学习路线](/#roadmap)

---

*持续更新中...*

